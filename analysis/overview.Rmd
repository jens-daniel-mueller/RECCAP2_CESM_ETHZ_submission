---
title: "Overview"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r load_libraries}
library(tidyverse)
library(gt)
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Load data

This analysis is based on Table 3 of the RECCAP2-ocean protocol for model output, and statistics of the ETHZ CESM model output.

The file list of the ETHZ CESM model output was created by running:

`ls -l > /UP_home/jenmueller/Projects/RECCAP2_CESM_ETHZ_submission/data/overview/CESM_files.txt`

while in folder: 

`/nfs/kryo/work/loher/CESM_output/RECCAP2/submit_Dec2020/split`


```{r load_overview_tables}

# prepare tab 3
tab3 <- read_csv(
  here::here(
    "data/overview",
    "RECCAP2-ocean_data_products_overview - Model_protocol_table3.csv"
  )
)

tab3_temp <- tab3 %>% 
  filter(variable_id == "epc100type / epc1000type") %>% 
  select(-variable_id)

tab3_temp <- expand_grid(
  tab3_temp,
  variable_id = c("epc100hard","epc1000hard","epc100soft","epc1000soft")
)

tab3 <- tab3 %>% 
  filter(variable_id != "epc100type / epc1000type")

tab3 <- bind_rows(tab3, tab3_temp)
rm(tab3_temp)

# prepare cesm file list
CESM_files <- read_table2("data/overview/CESM_files.txt",
                          col_names = FALSE,
                          skip = 1)


CESM_files <- CESM_files %>%
  select(X5, X9) %>%
  rename(file_size = X5,
         file_name = X9) %>%
  mutate(
    variable_id = str_split(file_name,
                            pattern = "_CESM",
                            simplify = TRUE)[, 1],
    experiment_id = str_sub(string = file_name,-19,-19)
  ) %>%
  mutate(
    experiment_id = if_else(
      experiment_id %in% c("A", "B", "C", "D"),
      experiment_id,
      "ancillary"
    ),
    variable_id = if_else(variable_id == "atmpco2", "pco2atm", variable_id),
    file_size_MB = file_size*1e-6
  ) %>%
  select(-c(file_name, file_size))

# join file list and tab 3
overview <- full_join(tab3, CESM_files) %>%
  arrange(variable_id)

overview <- overview %>%
  filter(!is.na(experiment_id),
         variable_id != "siconc") %>% 
  mutate(file_size_MB = round(file_size_MB,1))

rm(CESM_files, tab3)

```

# Overview CESM output

Overview table of output files created. Please note, that for each listed variable, `four experiment_id (A-D) versions` exist.

```{r files_list}

overview %>% 
  group_by(variable_id, dimension, priority) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE) %>% 
  arrange(dimension, priority) %>% 
  gt(
    rowname_col = "variable_id",
    groupname_col = c("dimension", "priority"),
    row_group.sep = " | Priority: "
  ) %>%
  summary_rows(groups = TRUE,
               fns = list(total = "sum"))

```


#  Compare tar variants

In the following, the sum of file sizes is calculated for some variants to group the files. Grouping variables are named according to Table 3 in the model protocol.

## experiment_id

```{r experiment_id}

overview %>% 
  group_by(experiment_id) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE) %>% 
  arrange(file_size_MB, experiment_id)

overview <- overview %>% 
  filter(experiment_id != "ancillary",
         !is.na(priority))

```

Ancillary data will be excluded for the following analysis, but needs to be included into one of the tar levels, or provided seperately.

## dimension x priority

```{r dimension_priority}

overview %>% 
  group_by(dimension, priority) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
```


## dimension x experiment_ID

```{r dimension_experiment}

overview %>% 
  group_by(dimension, experiment_id) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
```

## dimension x priority x experiment_ID

```{r dimension_priority_experiment}

overview %>% 
  group_by(dimension, priority, experiment_id) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
```

## Custom: 2D phy vs bio

```{r assign_phy_vars}

phy_vars <- c(
  "fgco2",
  "fgco2_glob",
  "fgco2_reg",
  "spco2",
  "fice",
  "Kw",
  "pco2atm",
  "alpha",
  "mld",
  "tos",
  "sos",
  "dissicos",
  "talkos",
  "no3os",
  "po4os",
  "sios"
)


```

To support the analysis of surface fluxes, following 2D-variables could be tarred separately:

`r phy_vars`

```{r phy_file_size}

overview <- overview %>%
  mutate(tar = case_when(
    variable_id %in% phy_vars &
      dimension == "2D" ~ "phy_surf",
    TRUE ~ "rest"
  ))

overview %>% 
  group_by(tar, dimension) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
  
```

