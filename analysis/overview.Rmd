---
title: "Overview"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r load_libraries}
library(tidyverse)
library(gt)
```

```{r ggplot_theme, include = FALSE}
theme_set(theme_bw())
```

# Load data

This analysis is based on Table 3 of the RECCAP2-ocean protocol for model output, and statistics of the ETHZ CESM model output.

```{r Table_3_from_protocol}

# read Table 3 from model protocol
table_3 <- read_csv(
  here::here(
    "data/overview",
    "RECCAP2-ocean_data_products_overview - Model_protocol_table3.csv"
  )
)

# replace placeholder variable name with actual CESM variable name
table_3_temp <- table_3 %>% 
  filter(variable_id == "epc100type / epc1000type") %>% 
  select(-variable_id)

table_3_temp <- expand_grid(
  table_3_temp,
  variable_id = c("epc100hard","epc1000hard","epc100soft","epc1000soft")
)

table_3 <- table_3 %>% 
  filter(variable_id != "epc100type / epc1000type")

table_3 <- bind_rows(table_3, table_3_temp)
rm(table_3_temp)

```


The list of files and sizes of the ETHZ CESM model output refers to the content in this folder:

```{r CESM_output_files_list}

# set path to output
path_CESM <-
  "/nfs/kryo/work/loher/CESM_output/RECCAP2/submit_Dec2020/split"
path_CESM

# create list of CESM output files and sizes

CESM_files_names <- list.files(path = path_CESM)
CESM_files_sizes <-
  file.size(paste(path_CESM, CESM_files_names, sep = "/"))

CESM_files <- bind_cols(file_name = CESM_files_names,
                        file_size_MB = CESM_files_sizes * 1e-6)

rm(path_CESM, CESM_files_names, CESM_files_sizes)

# extract variable_id and experiment_id from file name
CESM_files <- CESM_files %>%
  mutate(
    variable_id = str_split(file_name,
                            pattern = "_CESM",
                            simplify = TRUE)[, 1],
    experiment_id = str_sub(string = file_name, -19, -19)
  ) %>%
  mutate(experiment_id = if_else(
    experiment_id %in% c("A", "B", "C", "D"),
    experiment_id,
    "ancillary"
  )) %>%
  select(-c(file_name))

# correct errornous file name in CESM output
CESM_files <- CESM_files %>%
  mutate(variable_id = if_else(variable_id == "atmpco2", "pco2atm", variable_id))

```

```{r create_overview_table}

# join file list and tab 3
overview <- full_join(table_3, CESM_files) %>%
  arrange(variable_id)

overview <- overview %>%
  filter(!is.na(experiment_id),
         variable_id != "siconc") %>% 
  mutate(file_size_MB = round(file_size_MB,1))

rm(CESM_files, table_3)

overview %>% 
  write_csv("data/overview/overview_files.csv")

```

# Overview CESM output

Overview table of output files created. Please note, that for each listed variable, `four experiment_id (A-D) versions` exist.

```{r files_list}

overview %>% 
  group_by(variable_id, dimension, priority) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE) %>% 
  arrange(dimension, priority) %>% 
  gt(
    rowname_col = "variable_id",
    groupname_col = c("dimension", "priority"),
    row_group.sep = " | Priority: "
  ) %>%
  summary_rows(groups = TRUE,
               fns = list(total = "sum"))

```


#  Compare tar variants

In the following, the sum of file sizes is calculated for some variants to group the files. Grouping variables are named according to Table 3 in the model protocol.

## experiment_id

```{r experiment_id}

overview %>% 
  group_by(experiment_id) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE) %>% 
  arrange(file_size_MB, experiment_id)

overview <- overview %>% 
  filter(experiment_id != "ancillary",
         !is.na(priority))

```

Ancillary data will be excluded for the following analysis, but needs to be included into one of the tar levels, or provided seperately.

## dimension x priority

```{r dimension_priority}

overview %>% 
  group_by(dimension, priority) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
```


## dimension x experiment_ID

```{r dimension_experiment}

overview %>% 
  group_by(dimension, experiment_id) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
```

## dimension x priority x experiment_ID

```{r dimension_priority_experiment}

overview %>% 
  group_by(dimension, priority, experiment_id) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
```

## Custom: 2D phy vs bio

```{r assign_phy_vars}

phy_vars <- c(
  "fgco2",
  "fgco2_glob",
  "fgco2_reg",
  "spco2",
  "fice",
  "Kw",
  "pco2atm",
  "alpha",
  "mld",
  "tos",
  "sos",
  "dissicos",
  "talkos",
  "no3os",
  "po4os",
  "sios"
)


```

To support the analysis of surface fluxes, following 2D-variables could be tarred separately:

`r phy_vars`

```{r phy_file_size}

overview <- overview %>%
  mutate(tar = case_when(
    variable_id %in% phy_vars &
      dimension == "2D" ~ "phy_surf",
    TRUE ~ "rest"
  ))

overview %>% 
  group_by(tar, dimension) %>% 
  summarise_at("file_size_MB", sum, na.rm = TRUE)
  
  
```

